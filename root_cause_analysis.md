# MATLAB vs Python Figure 1 根本原因分析

## 关键数据对比

### 1. 起点坐标差异
```
MATLAB B2_start: [4.904878, 2.725374, -0.200000]
Python B2_start: [4.045085, 2.938926, -0.200000]
差异: [0.859793, -0.213552, 0.000000]
```

### 2. 终点坐标差异
```
MATLAB B2_end: [-4.904878, -0.200000, 0.200000]
Python B2_end: [-4.938442, 0.782172, 0.200000]
差异: [0.033564, -0.982172, 0.000000]
```

### 3. 光束方向向量差异
```
MATLAB p1: [-9.809757, -2.925374, 0.400000]
Python p1: [-8.983527, -2.156754, 0.400000]
差异: [-0.826230, -0.768620, 0.000000]
```

## 根本原因分析

### 🔍 主要问题1: 坐标转换逻辑错误
- MATLAB中使用了`B2=B2/1000.0`进行单位转换（mm→m）
- Python代码中缺少这个关键的单位转换步骤
- 这导致所有笛卡尔坐标都存在系统性偏差

### 🔍 主要问题2: 网格初始化起点错误
- **MATLAB**: `xls=ones(div1_2,div2_2,divls_2)*B2(2,1)` - 从**检测点**开始
- **Python**: `xls=...*B2_start` - 从**注入点**开始
- 这导致整个网格的起点完全不同！

### 🔍 主要问题3: 光束方向向量计算错误
- MATLAB: `p1=B2(1,:)-B2(2,:)` (从检测点指向注入点)
- Python: `p1=B2_end-B2_start` (从注入点指向检测点)
- 方向完全相反！

## 具体修正方案

### 修正1: 添加正确的单位转换
```python
# 在beam_geometry.py中，在坐标转换后添加
B2 = B2 / 1000.0  # mm → m
```

### 修正2: 修正网格初始化起点
```python
# 从检测点开始初始化，而不是从注入点
xls = torch.ones(div1_2, div2_2, divls_2, device=device) * B2_end[0]
yls = torch.ones(div1_2, div2_2, divls_2, device=device) * B2_end[1] 
zls = torch.ones(div1_2, div2_2, divls_2, device=device) * B2_end[2]
```

### 修正3: 修正光束方向向量
```python
# MATLAB逻辑: p1 = B2(1,:) - B2(2,:) (检测点 - 注入点)
p1[0] = B2_start[0] - B2_end[0]
p1[1] = B2_start[1] - B2_end[1] 
p1[2] = B2_start[2] - B2_end[2]
```

## 影响分析
这些修正将解决：
1. ✅ Figure 1中光束路径的准确位置
2. ✅ 起点和终点标记的正确位置
3. ✅ 托卡马克边界与光束的相对位置
4. ✅ 整体3D几何形状的准确性

## 验证方法
修正后重新运行对比分析，应该看到：
- 坐标差异接近0 (< 1e-10)
- 网格点完全匹配
- 光束方向向量一致
