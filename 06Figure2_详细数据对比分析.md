# Figure 2 详细数据对比分析报告

**文档版本**: 1.0  
**创建日期**: 2025年11月11日  
**分析目标**: 深入对比Python与MATLAB在Figure 2（PCI信号强度图）方面的数据差异

## 🔍 当前发现的关键问题

### 1. 数据稀疏性问题
```python
总采样点数: 189,063
非零点数: 860
非零比例: 0.5%
```

**问题**: 超过99%的采样点返回0值，这表明：
- 边界检查过于严格
- 插值算法可能有问题
- 坐标转换可能有误

### 2. 数值范围异常
```python
线积分数据范围: [-66.687, 61.334]
PCI信号范围: [-49.807, 0.000]  # 全是负数或零
abs(pout)范围: [0.000, 49.807]
```

**问题**: 
- PCI信号全是负数，这不符合物理预期
- 数值范围波动很大，可能存在数值不稳定

### 3. MATLAB参考数据结构
从文档分析，MATLAB中：
- `pout`: 1D PCI信号数组
- `pout2`: 2D检测器信号数组
- `plot(abs(pout))`: 显示信号强度分布

## 📊 详细数据分析

### Python当前数据特征
| 指标 | 线积分数据 | 中心PCI信号 | abs(pout) |
|------|------------|-------------|-----------|
| 数据点数 | 189,063 | 3,001 | 3,001 |
| 非零点数 | 860 | 变化中 | 变化中 |
| 最小值 | -66.687 | -49.807 | 0.000 |
| 最大值 | 61.334 | 0.000 | 49.807 |
| 均值 | -4.605 | -0.188 | 0.188 |
| 标准差 | 26.775 | 2.859 | 2.859 |

### 预期MATLAB数据特征（待获取）
| 指标 | 预期pout | 预期pout2 |
|------|----------|-----------|
| 数据点数 | ~3,000 | 9×7 |
| 数值范围 | 需要验证 | 需要验证 |
| 分布特征 | 需要验证 | 需要验证 |

## 🎯 关键问题分析

### 问题1: 插值成功率过低
**现象**: 0.5%的非零率过低  
**可能原因**:
1. 坐标转换错误 - 采样点可能不在有效范围内
2. 边界检查过严 - GAC边界判断可能有问题
3. 插值算法问题 - 三线性插值可能在边界处失效

**调试建议**:
```python
# 检查前100个采样点的坐标和边界状态
for i in range(100):
    R, Z, PHI = beam_coords[i]
    r, theta = coordinate_convert(R, Z)
    inside_boundary = check_boundary(r, theta)
    if inside_boundary:
        interpolated_value = trilinear_interpolation(R, Z, PHI)
```

### 问题2: 负数值过多
**现象**: 所有非零值都是负数或零  
**可能原因**:
1. 密度场数据本身是负数
2. 积分方向或权重计算错误
3. 坐标系转换导致符号错误

**调试建议**:
```python
# 检查原始密度场数据
print(f"密度场统计: min={density.min()}, max={density.max()}")
print(f"密度场均值: {density.mean()}")
print(f"负值比例: {(density < 0).sum() / density.numel() * 100:.1f}%")
```

### 问题3: 数值范围不稳定
**现象**: 从-66到+61的大范围波动  
**可能原因**:
1. 插值权重计算错误
2. 数值精度问题
3. 数组索引越界导致读取到错误数据

**调试建议**:
```python
# 检查插值权重
weights = compute_trilinear_weights(R, Z, PHI)
print(f"权重和: {weights.sum()}")
print(f"权重范围: [{weights.min()}, {weights.max()}]")
```

## 🔧 修复计划

### 阶段1: 数据验证
1. **检查密度场数据** - 确认原始数据范围和分布
2. **验证光束路径** - 确认采样点坐标转换正确
3. **测试边界检查** - 验证GAC边界判断逻辑

### 阶段2: 插值优化
1. **改进坐标转换** - 修复mod函数和bisec查找
2. **优化权重计算** - 确保三线性插值权重正确
3. **增强数值稳定性** - 添加边界容差和异常处理

### 阶段3: MATLAB对比
1. **生成MATLAB参考数据** - 运行原始MATLAB代码
2. **逐点数值对比** - 对比相同坐标点的插值结果
3. **统计分析对比** - 比较整体分布特征

## 📈 预期改进效果

### 修复后目标指标
| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| 非零率 | 0.5% | >80% |
| 数值范围 | [-66, 61] | 合理物理范围 |
| 分布特征 | 全负数 | 正负混合 |
| MATLAB一致性 | 未知 | >90% |

### 验证方法
1. **可视化检查** - Figure 2图形应该显示合理的信号分布
2. **统计对比** - 与MATLAB结果的数值统计对比
3. **物理合理性** - 确保结果符合PCI物理预期

## 🚨 紧急修复项

### 1. 立即检查
- [ ] 原始密度场数据范围和符号
- [ ] 光束坐标转换是否正确
- [ ] 边界检查逻辑是否有问题

### 2. 快速修复
- [ ] 调整容差参数
- [ ] 修复可能的索引错误
- [ ] 改进异常处理

### 3. 验证测试
- [ ] 对比修复前后的数据分布
- [ ] 验证Figure 2图形合理性
- [ ] 与MATLAB结果进行对比

## 📝 下一步行动

1. **等待当前任务完成** - 检查新的MATLAB兼容数据
2. **运行MATLAB参考** - 生成标准对比数据
3. **实施修复方案** - 根据发现的问题逐一解决
4. **重新测试验证** - 确认修复效果

---

**当前状态**: 发现重大数据问题，需要紧急修复  
**优先级**: 高 - 影响核心功能正确性  
**预计修复时间**: 2-4小时详细调试
