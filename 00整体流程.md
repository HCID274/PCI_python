## 📋 MATLAB代码PCI整体流程（6阶段划分）

### **第1阶段：参数解析和路径配置**
- **入口函数**：`LSview_com('GENE', 301, 98.07, 4)`
- **参数解析**：
  - 仿真类型: 'GENE'
  - 数据编号: 301  
  - 时间点: 98.07
  - 变量类型: 4 (潜在扰动)
- **路径配置**：读取path_matlab.txt
  - 输入目录: `/work/DTMP/lhqing/PCI/Data/matlab_input/301/`
  - 输出目录: `/work/DTMP/lhqing/PCI/Data/matlab_output/`
  - 字节序: ieee-le

### **第2阶段：GENE配置和Equilibrium数据加载**
- **参数文件读取**：调用`fread_param2.m`
  - 解析FORTRAN namelist格式
  - 提取网格参数 (nx0, nky0, nz0)
  - 提取物理参数 (q0, shat, trpeps)
- **Equilibrium数据读取**：
  - `fread_EQ1.m` → `fread_EQcod3.m`：磁通坐标数据 (GRC, GZC, GFC)
  - `fread_EQ1.m` → `fread_EQmag.m`：磁场数据 (GBPR, GBPZ, GBTP, GBPP)
- **派生参数计算**：B_ref, rho_ref等归一化参数

### **第3阶段：光束配置和几何计算**
- **光束参数加载**：解析`LS_condition_JT60SA.txt`
  - 注入点坐标 (B2_start)
  - 检测点坐标 (B2_end)
  - 光束宽度 (wid1, wid2)
  - 网格细分参数 (div1, div2, divls)
- **几何计算**：
  - 计算光束方向向量：`p1 = B2_start - B2_end`
  - phi角度转换：`phi * 2 * π`
  - 生成3D光束采样网格：`(div1*2+1, div2*2+1, divls+1, 3)`

### **第4阶段：数据预处理和时间序列处理**
- **文本数据转换**：`generate_timedata.m`
  - 读取`TORUSIons_act_9807.dat`
  - 转换为二进制格式`00009807.dat`
- **密度场数据处理**：`fread_data_s.m + probe_multi2.m`
  - Reshape为3D数组：`(ntheta, nx, nz)`
  - 添加径向边界：`nx0 → nx0+1`
  - 添加toroidal边界：`nz → nz+1`
  - 扩展径向维度：inside/outside padding
  - 重新排列poloidal数据和周期边界处理

### **第5阶段：PCI正向投影计算（核心算法）**
- **光束路径计算**：
  - 笛卡尔坐标 → 柱坐标转换
  - 柱坐标 → 磁通坐标转换
  - 沿光束路径积分
- **3D插值计算**：`probeEQ_local_s.m`（第100-121行）
  - 坐标转换：相对plasma axis的(r, theta)计算
  - bisec查找：theta/r/phi索引定位
  - 边界检查：plasma内外判断逻辑
  - 网格索引：8个顶点边界值获取
  - 权重计算：三线性插值权重
  - 插值结果：密度场采样值
- **线积分和信号处理**：
  - 沿光束方向积分 (line integral)
  - 生成pout1: 3D光束积分信号
  - 生成pout2: 2D检测器信号 `[div1_2 x div2_2]`

### **第6阶段：可视化和结果输出**
- **核心图表生成**：
  - Figure 1: 3D光束几何图
  - Figure 2: PCI信号强度图
  - Figure 3: 检测器信号等高线图
  - Figure 4: 2D波数空间图
  - Figure 5: 光束位置截面图
- **磁场分析图表**：Figures 201-203 (By, Bx, 磁场角度)
- **局部性分析图表**：Figure 21, 301-304 (涨落对比分析)

## 🎯 流程核心特点

1. **模块化设计**：每个阶段职责明确，便于调试和维护
2. **数据流驱动**：从配置→数据→计算→可视化的完整流水线
3. **坐标转换复杂**：涉及笛卡尔、柱坐标、磁通坐标多重转换
4. **插值算法核心**：三线性插值是整个流程的技术难点
5. **多维度可视化**：13个不同类型的图表展示不同物理量

这个6阶段划分清晰展现了MATLAB PCI代码从输入配置到最终输出的完整工作流程，每个阶段都有明确的技术目标和实现方法。