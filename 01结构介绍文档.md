# PyPCI ä»£ç ç»“æ„æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025å¹´11æœˆ6æ—¥  
**çŠ¶æ€**: âœ… å®Œæ•´å¤ç°MATLABåŠŸèƒ½

---

## ç›®å½•

1. [é¡¹ç›®ç»“æ„æ¦‚è§ˆ](#é¡¹ç›®ç»“æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
3. [æ ¹ç›®å½•è„šæœ¬è¯¦è§£](#æ ¹ç›®å½•è„šæœ¬è¯¦è§£)
4. [MATLABå¯¹åº”å…³ç³»](#matlabå¯¹åº”å…³ç³»)
5. [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)
6. [å…³é”®ä¿®æ­£è®°å½•](#å…³é”®ä¿®æ­£è®°å½•)

---

## é¡¹ç›®ç»“æ„æ¦‚è§ˆ

```
pyPCI/
â”œâ”€â”€ pci_torch/              # æ ¸å¿ƒPythonåŒ…
â”‚   â”œâ”€â”€ __init__.py         # åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config.py           # é…ç½®æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ data_loader.py      # æ•°æ®åŠ è½½å’Œé¢„å¤„ç†
â”‚   â”œâ”€â”€ beam_geometry.py    # å…‰æŸå‡ ä½•è®¡ç®—
â”‚   â”œâ”€â”€ coordinates.py      # åæ ‡è½¬æ¢
â”‚   â”œâ”€â”€ interpolation.py    # æ’å€¼å‡½æ•°
â”‚   â”œâ”€â”€ forward_model.py   # PCIæ­£å‘æŠ•å½±æ¨¡å‹
â”‚   â”œâ”€â”€ batch_processor.py # æ‰¹é‡æ—¶é—´åºåˆ—å¤„ç†
â”‚   â”œâ”€â”€ fft_analysis.py    # FFTé¢‘è°±åˆ†æ
â”‚   â”œâ”€â”€ visualization.py   # å¯è§†åŒ–å·¥å…·
â”‚   â”œâ”€â”€ utils.py           # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ path_config.py    # è·¯å¾„é…ç½®ç®¡ç†
â”‚
â”œâ”€â”€ examples/               # ç¤ºä¾‹è„šæœ¬
â”‚   â”œâ”€â”€ complete_pipeline.py  # å®Œæ•´pipelineç¤ºä¾‹
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ tests/                  # æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ æ ¹ç›®å½•Pythonè„šæœ¬        # æ ¹ç›®å½•ä¸‹çš„ç‹¬ç«‹è„šæœ¬
â”‚   â”œâ”€â”€ setup.py           # åŒ…å®‰è£…é…ç½®
â”‚   â”œâ”€â”€ preprocess_data.py  # æ•°æ®é¢„å¤„ç†è„šæœ¬
â”‚   â”œâ”€â”€ diagnose_gpu.py    # GPUè¯Šæ–­è„šæœ¬
â”‚   â”œâ”€â”€ test_single_time.py # å•æ—¶é—´ç‚¹æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_probeEQ_details.py  # ProbeEQè¯¦ç»†æµ‹è¯•
â”‚   â”œâ”€â”€ test_equdata_debug.py    # Equilibriumæ•°æ®è°ƒè¯•
â”‚   â”œâ”€â”€ test_equdata_è¯¦ç»†.py      # Equilibriumæ•°æ®è¯¦ç»†æµ‹è¯•
â”‚   â””â”€â”€ test_matlab_indexing.py  # MATLABç´¢å¼•æµ‹è¯•
â”‚
â”œâ”€â”€ PBSä½œä¸šè„šæœ¬             # PBSä½œä¸šæäº¤è„šæœ¬
â”‚   â”œâ”€â”€ run_pci_gpu.pbs    # GPUä½œä¸šè„šæœ¬
â”‚   â”œâ”€â”€ run_preprocess.pbs # é¢„å¤„ç†ä½œä¸šè„šæœ¬
â”‚   â””â”€â”€ run_preprocess_cpu.pbs  # CPUé¢„å¤„ç†ä½œä¸š
â”‚
â”œâ”€â”€ Shellè„šæœ¬               # Shellè¾…åŠ©è„šæœ¬
â”‚   â”œâ”€â”€ run_single_test.sh # å•æ—¶é—´ç‚¹æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ setup_venv.sh      # è™šæ‹Ÿç¯å¢ƒè®¾ç½®
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ æ–‡æ¡£                    # æ–‡æ¡£æ–‡ä»¶
    â”œâ”€â”€ 01ç»“æ„ä»‹ç»æ–‡æ¡£.md   # æœ¬æ–‡ä»¶
    â”œâ”€â”€ MATLAB_PYTHON_COMPARISON_CHECKLIST.md  # å¯¹æ¯”æ£€æŸ¥æ¸…å•
    â””â”€â”€ ...
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. `pci_torch/config.py`

**ä½œç”¨**: å®šä¹‰é…ç½®æ•°æ®ç»“æ„å’Œå‚æ•°ç®¡ç†

**ä¸»è¦ç±»**:
- `GENEConfig`: GENEä»¿çœŸé…ç½®
  - ç½‘æ ¼å‚æ•° (nx0, nky0, nz0)
  - å‡ ä½•å‚æ•° (q0, shat, trpeps)
  - Equilibriumæ•°æ® (PA, GAC, GTC_c, GRC, GZCç­‰)
  - å½’ä¸€åŒ–å‚æ•° (B_ref, rho_refç­‰)
  
- `BeamConfig`: å…‰æŸé…ç½®
  - æ³¨å…¥ç‚¹å’Œæ£€æµ‹ç‚¹åæ ‡
  - å…‰æŸå®½åº¦å’Œé‡‡æ ·å‚æ•°
  - æ£€æµ‹å™¨é˜µåˆ—é…ç½®

**å¯¹åº”MATLAB**: 
- `@GENEClass` ç±»çš„å±æ€§å®šä¹‰
- æ— ç›´æ¥å¯¹åº”çš„å•ä¸€æ–‡ä»¶ï¼Œåˆ†æ•£åœ¨å¤šä¸ªMATLABç±»ä¸­

---

### 2. `pci_torch/data_loader.py`

**ä½œç”¨**: æ•°æ®åŠ è½½ã€è§£æå’Œé¢„å¤„ç†

**ä¸»è¦å‡½æ•°**:

#### 2.1 å‚æ•°è§£æ
- **`parse_parameters_dat(file_path)`**
  - è§£æ`parameters.dat`æ–‡ä»¶ï¼ˆFORTRAN namelistæ ¼å¼ï¼‰
  - æå–æ‰€æœ‰GENEä»¿çœŸå‚æ•°
  - **å¯¹åº”MATLAB**: `@GENEClass/fread_param2.m`

#### 2.2 Equilibriumæ•°æ®åŠ è½½
- **`load_equdata_BZ(file_path, config, device)`**
  - è¯»å–`equdata_BZ`æ–‡ä»¶ï¼ˆLittle-EndianäºŒè¿›åˆ¶ï¼‰
  - è§£æç£é€šåæ ‡æ•°æ® (GRC, GZC, GFC)
  - æ‰§è¡Œå¾„å‘å’Œæå‘æ’å€¼
  - è®¡ç®—plasma axis (PA) å’Œminor radius (GAC)
  - **å¯¹åº”MATLAB**: `@task_eqClass/fread_EQcod3.m`

- **`load_equdata_be(file_path, PA, device)`**
  - è¯»å–`equdata_be`æ–‡ä»¶ï¼ˆBig-EndianäºŒè¿›åˆ¶ï¼‰
  - è§£æç£åœºåˆ†é‡ (GBPR, GBPZ, GBTP, GBPP)
  - å¤„ç†ç½‘æ ¼å‚æ•° (RG, DR)
  - **å¯¹åº”MATLAB**: `@task_eqClass/fread_EQmag.m`

- **`load_equilibrium_data(equilibrium_dir, config, device)`**
  - ç»Ÿä¸€åŠ è½½equilibriumæ•°æ®çš„æ¥å£
  - è°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°
  - **å¯¹åº”MATLAB**: `fread_EQ1.m` (ç»„åˆå‡½æ•°)

#### 2.3 æ—¶é—´åºåˆ—æ•°æ®é¢„å¤„ç†
- **`separate_torusdata(input_file, output_dir, time_n, tol_n)`**
  - åˆ†å‰²å¤§å‹`TORUSIons_act.dat`æ–‡ä»¶ä¸ºæ—¶é—´åºåˆ—æ–‡ä»¶
  - ç”Ÿæˆ`TORUSIons_act_XXXX.dat`æ–‡ä»¶
  - **å¯¹åº”MATLAB**: `separate_torusdata.m`

- **`generate_timedata(config, text_file, time_t, output_dir)`**
  - å°†æ–‡æœ¬æ ¼å¼çš„`TORUSIons_act_XXXX.dat`è½¬æ¢ä¸ºäºŒè¿›åˆ¶doubleæ ¼å¼
  - ç”Ÿæˆ`XXXXXX.dat`äºŒè¿›åˆ¶æ–‡ä»¶
  - **å¯¹åº”MATLAB**: `@GENEClass/generate_timedata.m`

- **`fread_data_s(config, binary_file, device)`**
  - è¯»å–äºŒè¿›åˆ¶å¯†åº¦åœºæ•°æ®
  - æ‰§è¡Œå®Œæ•´çš„æ•°æ®å¤„ç†æµç¨‹ï¼š
    1. Reshapeä¸º3Dæ•°ç»„ (ntheta, nx, nz)
    2. æ·»åŠ å¾„å‘è¾¹ç•Œ (nx0 â†’ nx0+1)
    3. æ·»åŠ toroidalè¾¹ç•Œ (nz â†’ nz+1)
    4. æ‰©å±•å¾„å‘ç»´åº¦ (inside/outside padding)
    5. é‡æ–°æ’åˆ—poloidalæ•°æ®
    6. æ·»åŠ å‘¨æœŸè¾¹ç•Œ
  - **å¯¹åº”MATLAB**: `@GENEClass/fread_data_s.m` + `probe_multi2.m` (ç¬¬82-106è¡Œ)

#### 2.4 é…ç½®åŠ è½½
- **`load_gene_config_from_parameters(parameters_file, equilibrium_dir, device)`**
  - å®Œæ•´åŠ è½½GENEé…ç½®çš„å…¥å£å‡½æ•°
  - ç»„åˆå‚æ•°è§£æå’Œequilibriumæ•°æ®åŠ è½½
  - **å¯¹åº”MATLAB**: `fread_param2.m` + `fread_EQ1.m`

- **`load_beam_config(ls_condition_file)`**
  - åŠ è½½å…‰æŸé…ç½®æ–‡ä»¶`LS_condition_JT60SA.txt`
  - è§£ææ³¨å…¥ç‚¹å’Œæ£€æµ‹ç‚¹åæ ‡
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬54-60è¡Œ)

---

### 3. `pci_torch/beam_geometry.py`

**ä½œç”¨**: è®¡ç®—PCIå…‰æŸçš„å‡ ä½•å½¢çŠ¶å’Œé‡‡æ ·ç½‘æ ¼

**ä¸»è¦å‡½æ•°**:

- **`compute_beam_grid(beam_config, device)`**
  - è®¡ç®—å…‰æŸçš„æ‰€æœ‰é‡‡æ ·ç‚¹ï¼ˆç¬›å¡å°”åæ ‡ï¼‰
  - ç”Ÿæˆ3Dç½‘æ ¼: (div1*2+1, div2*2+1, divls+1, 3)
  - è®¡ç®—å…‰æŸæ–¹å‘å‘é‡å’Œå‚ç›´å‘é‡
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬62-133è¡Œ)
  - **å…³é”®ä¿®æ­£**: 
    - âœ… å…‰æŸæ–¹å‘å‘é‡: `p1 = B2_start - B2_end` (ä»ç»ˆç‚¹æŒ‡å‘èµ·ç‚¹)
    - âœ… phiè§’åº¦è½¬æ¢: `phi * 2 * np.pi`

- **`compute_beam_path_center(beam_config, device)`**
  - è®¡ç®—å…‰æŸä¸­å¿ƒè·¯å¾„çš„é‡‡æ ·ç‚¹
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬155-158è¡Œ)

- **`get_detector_positions(beam_config, device)`**
  - è·å–æ£€æµ‹å™¨é˜µåˆ—çš„ä½ç½®
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬212-213è¡Œ)

- **`visualize_beam_geometry(beam_grid, config, save_path)`**
  - å¯è§†åŒ–å…‰æŸå‡ ä½•ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬136-153è¡Œ)

---

### 4. `pci_torch/coordinates.py`

**ä½œç”¨**: åæ ‡ç³»ç»Ÿè½¬æ¢

**ä¸»è¦å‡½æ•°**:

- **`cartesian_to_cylindrical(x, y, z)`**
  - ç¬›å¡å°”åæ ‡ â†’ æŸ±åæ ‡ (R, Z, phi)
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬174-180è¡Œ)

- **`cylindrical_to_flux(R, Z, phi, config)`**
  - æŸ±åæ ‡ â†’ ç£é€šåæ ‡ (rho, theta, phi)
  - ä½¿ç”¨equilibriumæ•°æ®è¿›è¡Œè½¬æ¢
  - **å¯¹åº”MATLAB**: é›†æˆåœ¨`probeEQ_local_s.m`ä¸­

- **`cartesian_to_flux(x, y, z, config)`**
  - ç¬›å¡å°”åæ ‡ â†’ ç£é€šåæ ‡
  - ç»„åˆä¸Šè¿°ä¸¤ä¸ªå‡½æ•°
  - **å¯¹åº”MATLAB**: é›†æˆåœ¨`probeEQ_*`ç³»åˆ—å‡½æ•°ä¸­

---

### 5. `pci_torch/interpolation.py`

**ä½œç”¨**: 3Dæ’å€¼å‡½æ•°

**ä¸»è¦å‡½æ•°**:

- **`probe_local_trilinear(density_3d, R, Z, PHI, config)`** â­æ ¸å¿ƒå‡½æ•°
  - åŸºäºequilibriumæ•°æ®çš„ç²¾ç¡®3Dä¸‰çº¿æ€§æ’å€¼
  - å®Œå…¨å¯¹åº”MATLABçš„`probeEQ_local_s.m`
  - å®ç°æ­¥éª¤ï¼š
    1. è®¡ç®—ç›¸å¯¹äºplasma axisçš„(r, theta)
    2. ä½¿ç”¨bisecæŸ¥æ‰¾thetaç´¢å¼•
    3. æ£€æŸ¥plasmaè¾¹ç•Œ
    4. ä½¿ç”¨bisecæŸ¥æ‰¾rå’Œphiç´¢å¼•
    5. è·å–8ä¸ªé¡¶ç‚¹çš„è¾¹ç•Œå€¼
    6. è®¡ç®—æ’å€¼æƒé‡
    7. æ‰§è¡Œä¸‰çº¿æ€§æ’å€¼
  - **å¯¹åº”MATLAB**: `@GENEClass/probeEQ_local_s.m`
  - **éªŒè¯çŠ¶æ€**: âœ… **ä¿®å¤å®ŒæˆéªŒè¯é€šè¿‡** (2024-11-07)
    - **ä¿®å¤å†…å®¹**:
      - ä¿®å¤GACæ•°æ®éå•è°ƒæ€§é—®é¢˜ï¼šä½¿ç”¨çº¿æ€§æŸ¥æ‰¾æ›¿ä»£bisec
      - ä¿®å¤é”™è¯¯è¾¹ç•Œæ£€æŸ¥ï¼šä½¿ç”¨å®é™…æœ€å°æœ€å¤§å€¼è€Œéé¦–å°¾å€¼
      - ä¿®å¤ç´¢å¼•è¶Šç•Œé—®é¢˜ï¼šæ·»åŠ è¾¹ç•Œæ£€æŸ¥
      - ä¿®å¤bisecå‡½æ•°ï¼šå®Œå…¨æŒ‰ç…§MATLABå®ç°
    - **éªŒè¯ç»“æœ**: 
      - å•ç‚¹æ’å€¼æµ‹è¯•: âœ… é€šè¿‡
      - è¾¹ç•Œæ¡ä»¶å¤„ç†: âœ… é€šè¿‡
      - ä¸MATLABé€»è¾‘ä¸€è‡´æ€§: âœ… é€šè¿‡
      - ç´¢å¼•èŒƒå›´æ£€æŸ¥: âœ… é€šè¿‡

- **`trilinear_interpolate_3d(data, positions, bounds, ...)`**
  - é€šç”¨çš„3Dä¸‰çº¿æ€§æ’å€¼å‡½æ•°
  - ç”¨äºç®€åŒ–ç‰ˆæœ¬çš„æ’å€¼

- **`sample_density_field(density_3d, positions, config)`**
  - ä»å¯†åº¦åœºä¸­é‡‡æ ·ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
  - ä½¿ç”¨`trilinear_interpolate_3d`

- **`bisec(value, array)`** â­ é‡è¦è¾…åŠ©å‡½æ•°
  - äºŒåˆ†æŸ¥æ‰¾å‡½æ•° - å®Œå…¨å¯¹åº”MATLABçš„`bisec.m`
  - ç”¨äºåœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾ç´¢å¼•
  - æ”¯æŒå‡åºå’Œé™åºæ•°ç»„
  - **éªŒè¯çŠ¶æ€**: âœ… **ä¿®å¤å®ŒæˆéªŒè¯é€šè¿‡** (2024-11-07)

---

### 6. `pci_torch/utils.py`

**ä½œç”¨**: å·¥å…·å‡½æ•°

**ä¸»è¦å‡½æ•°**:

- **`bisec(value, array)`**
  - æ ‡é‡äºŒåˆ†æŸ¥æ‰¾
  - **å¯¹åº”MATLAB**: `com/bisec.m`

- **`bisec_batch(values, array)`** â­å…³é”®å‡½æ•°
  - æ‰¹é‡äºŒåˆ†æŸ¥æ‰¾ï¼ˆGPUåŠ é€Ÿï¼‰
  - å¤„ç†å‡åºå’Œé™åºæ•°ç»„
  - **å¯¹åº”MATLAB**: `com/bisec.m`
  - **å…³é”®ä¿®æ­£**: âœ… æ·»åŠ å‡åº/é™åºæ£€æµ‹

- **`to_tensor(data, device, dtype)`**
  - å°†numpyæ•°ç»„è½¬æ¢ä¸ºPyTorchå¼ é‡

- **`ensure_batch_dim(x)` / `remove_batch_dim(x, was_added)`**
  - å¤„ç†batchç»´åº¦

---

### 7. `pci_torch/forward_model.py`

**ä½œç”¨**: PCIæ­£å‘æŠ•å½±æ¨¡å‹

**ä¸»è¦å‡½æ•°**:

- **`forward_projection(density_3d, config, beam_config, device, ...)`** â­æ ¸å¿ƒå‡½æ•°
  - å®Œæ•´çš„PCIæ­£å‘æŠ•å½±æµç¨‹ï¼š
    1. ç”Ÿæˆå…‰æŸé‡‡æ ·ç½‘æ ¼
    2. è½¬æ¢åˆ°æŸ±åæ ‡
    3. ä½¿ç”¨`probe_local_trilinear`è¿›è¡Œæ’å€¼
    4. æ²¿å…‰æŸæ–¹å‘ç§¯åˆ†
  - **å¯¹åº”MATLAB**: `LSview_com.m` + `probe_multi2.m`
  - **å…³é”®ä¿®æ­£**: âœ… ä½¿ç”¨`probe_local_trilinear`æ›¿ä»£ç®€åŒ–ç‰ˆæœ¬
  - **æœ€æ–°éªŒè¯**: âœ… 2024-11-07 å®Œå…¨é€šè¿‡MATLABä¸€è‡´æ€§éªŒè¯
  
- **`batch_forward_projection(density_batch, config, beam_config, device)`**
  - æ‰¹é‡å¤„ç†å¤šä¸ªæ—¶é—´å¿«ç…§
  
- **`compute_fft_spectrum(pci_signal, config)`**
  - è®¡ç®—FFTé¢‘è°±

**é‡è¦æ›´æ–° (2024-11-07)**:
- âœ… æ·»åŠ `_batch_probe_local_trilinear`ä¼˜åŒ–å‡½æ•°
- âœ… ä¿®å¤GPU NaNé—®é¢˜ï¼Œç¡®ä¿CPU/GPUç»“æœä¸€è‡´
- âœ… é€šè¿‡å®Œæ•´éªŒè¯ï¼šCPU vs GPUç»“æœé«˜åº¦ä¸€è‡´
- âœ… åˆ›å»ºè¯¦ç»†éªŒè¯æŠ¥å‘Šï¼š`MATLAB_FORWARD_MODEL_VERIFICATION_REPORT.md`

---

### 8. `pci_torch/batch_processor.py`

**ä½œç”¨**: æ‰¹é‡å¤„ç†æ—¶é—´åºåˆ—æ•°æ®

**ä¸»è¦å‡½æ•°**:

- **`process_time_series(input_dir, output_dir, config, beam_config, device, ...)`**
  - æ‰¹é‡å¤„ç†æ‰€æœ‰æ—¶é—´å¿«ç…§
  - è‡ªåŠ¨æ£€æµ‹æ—¶é—´æ•°æ®æ–‡ä»¶
  - ä¿å­˜MATæ–‡ä»¶ï¼ˆIntegratedSignalå’ŒLocalCross-Sectionï¼‰
  - **å¯¹åº”MATLAB**: `LSview_com_loop.m`

- **`process_single_timepoint(...)`**
  - å¤„ç†å•ä¸ªæ—¶é—´ç‚¹
  - **å¯¹åº”MATLAB**: `LSview_com.m`

- **`find_time_data_files(input_dir, pattern)`**
  - æŸ¥æ‰¾æ—¶é—´æ•°æ®æ–‡ä»¶

---

### 9. `pci_torch/fft_analysis.py`

**ä½œç”¨**: 3D FFTé¢‘è°±åˆ†æ

**ä¸»è¦ç±»**:

- **`FFT3DAnalyzer`**
  - 3D FFTåˆ†æå™¨ç±»
  - æ–¹æ³•ï¼š
    - `load_time_series()`: åŠ è½½æ—¶é—´åºåˆ—æ•°æ®
    - `compute_3d_fft()`: è®¡ç®—3D FFT
    - `analyze_mode1_kxky()`: kx-kyé¢‘è°±ï¼ˆå›ºå®šé¢‘ç‡ï¼‰
    - `analyze_mode2_wky()`: Ï‰-kyé¢‘è°±ï¼ˆå›ºå®škxï¼‰
    - `analyze_mode3_wkx()`: Ï‰-kxé¢‘è°±ï¼ˆå›ºå®škyï¼‰
    - `analyze_mode4_snapshot()`: æ—¶é—´å¿«ç…§åˆ†æ
    - `analyze_mode5_2dfft()`: 2D FFTï¼ˆæ—¶é—´å¹³å‡ï¼‰
  - **å¯¹åº”MATLAB**: `FFT_3D.m`

---

### 10. `pci_torch/visualization.py`

**ä½œç”¨**: å¯è§†åŒ–å·¥å…·

**ä¸»è¦ç±»**:

- **`PCIVisualizer`**
  - PCIå¯è§†åŒ–å·¥å…·ç±»
  - æ–¹æ³•ï¼š
    - `plot_detector_contour()`: æ£€æµ‹å™¨ä¿¡å·ç­‰é«˜çº¿å›¾
    - `plot_density_slice()`: å¯†åº¦åœºåˆ‡ç‰‡
    - `plot_wavenumber_space_2d()`: 2Dæ³¢æ•°ç©ºé—´å›¾
  - **å¯¹åº”MATLAB**: `LSview_com.m` (ç¬¬215-229è¡Œ) + `plotWaveNumberSpace.m`

---

### 11. `pci_torch/path_config.py`

**ä½œç”¨**: è·¯å¾„é…ç½®ç®¡ç†

**ä¸»è¦ç±»**:

- **`PathConfig`**
  - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ–‡ä»¶è·¯å¾„
  - é¿å…ç¡¬ç¼–ç è·¯å¾„
  - è‡ªåŠ¨åˆ›å»ºè¾“å‡ºç›®å½•
  - **å¯¹åº”MATLAB**: æ— ç›´æ¥å¯¹åº”ï¼ˆMATLABä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰

---

## æ ¹ç›®å½•è„šæœ¬è¯¦è§£

### 1. `setup.py`

**ä½œç”¨**: PyPCIåŒ…çš„å®‰è£…é…ç½®æ–‡ä»¶

**åŠŸèƒ½**:
- å®šä¹‰åŒ…å…ƒæ•°æ®ï¼ˆåç§°ã€ç‰ˆæœ¬ã€æè¿°ç­‰ï¼‰
- æŒ‡å®šä¾èµ–åŒ…ï¼ˆtorch, numpy, scipy, matplotlib, h5pyï¼‰
- é…ç½®åŒ…å‘ç°å’Œå®‰è£…

**å¯¹åº”MATLAB**: æ— ï¼ˆMATLABä½¿ç”¨ç±»è·¯å¾„ç®¡ç†ï¼‰

---

### 2. `preprocess_data.py`

**ä½œç”¨**: æ•°æ®é¢„å¤„ç†è„šæœ¬ï¼Œç”¨äºåˆ†å‰²å¤§å‹æ•°æ®æ–‡ä»¶

**åŠŸèƒ½**:
- åŠ è½½GENEé…ç½®
- åˆ†å‰²`TORUSIons_act.dat`ä¸ºæ—¶é—´åºåˆ—æ–‡ä»¶
- ç”Ÿæˆ`TORUSIons_act_XXXX.dat`æ–‡ä»¶

**ä¸»è¦å‡½æ•°**:
- `main()`: ä¸»å‡½æ•°ï¼Œæ‰§è¡Œæ•°æ®åˆ†å‰²æµç¨‹

**å¯¹åº”MATLAB**: 
- `separate_torusdata.m` (é€šè¿‡è°ƒç”¨`pci_torch.data_loader.separate_torusdata`)

**ä½¿ç”¨æ–¹å¼**:
```bash
python preprocess_data.py
# æˆ–é€šè¿‡PBSä½œä¸š
qsub run_preprocess.pbs
```

---

### 3. `diagnose_gpu.py`

**ä½œç”¨**: GPUå…¼å®¹æ€§è¯Šæ–­è„šæœ¬

**åŠŸèƒ½**:
- æ£€æŸ¥ROCmç‰ˆæœ¬
- æ£€æŸ¥PyTorchç‰ˆæœ¬å’ŒCUDA/ROCmæ”¯æŒ
- æµ‹è¯•GPUå¯ç”¨æ€§å’Œæ€§èƒ½
- è¯Šæ–­AMD MI300Aå…¼å®¹æ€§é—®é¢˜

**ä¸»è¦å‡½æ•°**:
- `check_rocm_version()`: æ£€æŸ¥ROCmç‰ˆæœ¬
- `check_pytorch()`: æ£€æŸ¥PyTorché…ç½®
- `test_gpu()`: æµ‹è¯•GPUåŠŸèƒ½

**å¯¹åº”MATLAB**: æ— ï¼ˆMATLABä½¿ç”¨ä¸åŒçš„GPUæ¥å£ï¼‰

**ä½¿ç”¨æ–¹å¼**:
```bash
python diagnose_gpu.py
```

---

### 4. `test_single_time.py`

**ä½œç”¨**: å•æ—¶é—´ç‚¹æµ‹è¯•è„šæœ¬ï¼Œç”¨äºéªŒè¯ä¸MATLABçš„ä¸€è‡´æ€§

**åŠŸèƒ½**:
- åŠ è½½é…ç½®å’Œequilibriumæ•°æ®
- åŠ è½½å…‰æŸé…ç½®
- è¯»å–å•ä¸ªæ—¶é—´ç‚¹çš„å¯†åº¦åœºæ•°æ®
- æ‰§è¡ŒPCIæ­£å‘æŠ•å½±
- ä¿å­˜æµ‹è¯•ç»“æœå’Œè¯¦ç»†æŠ¥å‘Š

**ä¸»è¦å‡½æ•°**:
- `test_single_timepoint(input_dir, output_dir, time_t, device)`: æµ‹è¯•å•ä¸ªæ—¶é—´ç‚¹

**å¯¹åº”MATLAB**: 
- `LSview_com.m` (å•æ—¶é—´ç‚¹ç‰ˆæœ¬)
- ç”¨äºéªŒè¯Pythonå®ç°ä¸MATLABçš„ä¸€è‡´æ€§

**ä½¿ç”¨æ–¹å¼**:
```bash
python test_single_time.py \
    --input_dir /path/to/input \
    --output_dir /path/to/output \
    --time_t 0.83 \
    --device cpu
```

---

### 5. `test_probeEQ_details.py`

**ä½œç”¨**: ProbeEQæ’å€¼å‡½æ•°çš„è¯¦ç»†æµ‹è¯•è„šæœ¬

**åŠŸèƒ½**:
- æµ‹è¯•equilibriumæ•°æ®åŠ è½½
- æµ‹è¯•å•ç‚¹å’Œå¤šç‚¹æ’å€¼
- éªŒè¯`probe_local_trilinear`å‡½æ•°çš„æ­£ç¡®æ€§

**å¯¹åº”MATLAB**: 
- `@GENEClass/probeEQ_local_s.m` (ç”¨äºéªŒè¯å¯¹åº”å…³ç³»)

**ä½¿ç”¨æ–¹å¼**:
```bash
python test_probeEQ_details.py
```

---

### 6. `test_equdata_debug.py`

**ä½œç”¨**: Equilibriumæ•°æ®è°ƒè¯•è„šæœ¬

**åŠŸèƒ½**:
- è°ƒè¯•equilibriumæ•°æ®åŠ è½½è¿‡ç¨‹
- æ£€æŸ¥æ•°æ®æ ¼å¼å’Œç»´åº¦
- éªŒè¯æ•°æ®è§£æçš„æ­£ç¡®æ€§

**å¯¹åº”MATLAB**: 
- `fread_EQcod3.m` å’Œ `fread_EQmag.m` (ç”¨äºè°ƒè¯•å¯¹åº”å…³ç³»)

---

### 7. `test_equdata_è¯¦ç»†.py`

**ä½œç”¨**: Equilibriumæ•°æ®çš„è¯¦ç»†æµ‹è¯•è„šæœ¬

**åŠŸèƒ½**:
- è¯¦ç»†æµ‹è¯•equilibriumæ•°æ®åŠ è½½
- éªŒè¯åæ ‡æ’å€¼é€»è¾‘
- æ£€æŸ¥æ•°æ®å®Œæ•´æ€§

**å¯¹åº”MATLAB**: 
- `fread_EQcod3.m` (è¯¦ç»†éªŒè¯)

---

### 8. `test_matlab_indexing.py`

**ä½œç”¨**: MATLABç´¢å¼•è½¬æ¢æµ‹è¯•è„šæœ¬

**åŠŸèƒ½**:
- æµ‹è¯•MATLAB 1-basedç´¢å¼•åˆ°Python 0-basedç´¢å¼•çš„è½¬æ¢
- éªŒè¯æ•°ç»„åˆ‡ç‰‡å’Œç´¢å¼•çš„æ­£ç¡®æ€§
- ç¡®ä¿ç´¢å¼•è½¬æ¢é€»è¾‘æ­£ç¡®

**å¯¹åº”MATLAB**: æ— ï¼ˆç”¨äºéªŒè¯ç´¢å¼•è½¬æ¢é€»è¾‘ï¼‰

---

## MATLABå¯¹åº”å…³ç³»

### å®Œæ•´å¯¹åº”è¡¨

| Pythonæ¨¡å—/å‡½æ•° | MATLABæ–‡ä»¶/å‡½æ•° | è¯´æ˜ |
|----------------|----------------|------|
| **æ•°æ®åŠ è½½** |
| `parse_parameters_dat()` | `@GENEClass/fread_param2.m` | å‚æ•°è§£æ |
| `load_equdata_BZ()` | `@task_eqClass/fread_EQcod3.m` | åæ ‡æ•°æ® |
| `load_equdata_be()` | `@task_eqClass/fread_EQmag.m` | ç£åœºæ•°æ® |
| `load_equilibrium_data()` | `fread_EQ1.m` | ç»„åˆåŠ è½½ |
| `separate_torusdata()` | `separate_torusdata.m` | æ•°æ®åˆ†å‰² |
| `generate_timedata()` | `@GENEClass/generate_timedata.m` | æ–‡æœ¬è½¬äºŒè¿›åˆ¶ |
| `fread_data_s()` | `@GENEClass/fread_data_s.m` + `probe_multi2.m` (82-106) | å¯†åº¦åœºè¯»å– |
| **å…‰æŸå‡ ä½•** |
| `compute_beam_grid()` | `LSview_com.m` (62-133) | å…‰æŸç½‘æ ¼ |
| **åæ ‡è½¬æ¢** |
| `cartesian_to_cylindrical()` | `LSview_com.m` (174-180) | ç¬›å¡å°”â†’æŸ±åæ ‡ |
| `cylindrical_to_flux()` | é›†æˆåœ¨`probeEQ_local_s.m` | æŸ±åæ ‡â†’ç£é€šåæ ‡ |
| **æ’å€¼** |
| `probe_local_trilinear()` | `@GENEClass/probeEQ_local_s.m` | ä¸‰çº¿æ€§æ’å€¼ â­ |
| `bisec_batch()` | `com/bisec.m` | äºŒåˆ†æŸ¥æ‰¾ |
| **æ­£å‘æŠ•å½±** |
| `forward_projection()` | `LSview_com.m` + `probe_multi2.m` | PCIæ­£å‘æŠ•å½± |
| **æ‰¹é‡å¤„ç†** |
| `process_time_series()` | `LSview_com_loop.m` | æ—¶é—´åºåˆ—å¤„ç† |
| **FFTåˆ†æ** |
| `FFT3DAnalyzer` | `FFT_3D.m` | 3D FFTåˆ†æ |
| **å¯è§†åŒ–** |
| `PCIVisualizer` | `LSview_com.m` (215-229) + `plotWaveNumberSpace.m` | å¯è§†åŒ– |
| **æ ¹ç›®å½•è„šæœ¬** |
| `preprocess_data.py` | `separate_torusdata.m` | æ•°æ®é¢„å¤„ç†è„šæœ¬ |
| `test_single_time.py` | `LSview_com.m` | å•æ—¶é—´ç‚¹æµ‹è¯• |
| `test_probeEQ_details.py` | `@GENEClass/probeEQ_local_s.m` | ProbeEQæµ‹è¯• |
| `test_equdata_debug.py` | `fread_EQcod3.m` + `fread_EQmag.m` | Equilibriumè°ƒè¯• |
| `test_equdata_è¯¦ç»†.py` | `fread_EQcod3.m` | Equilibriumè¯¦ç»†æµ‹è¯• |
| `diagnose_gpu.py` | æ—  | GPUè¯Šæ–­ï¼ˆPythonç‰¹æœ‰ï¼‰ |
| `test_matlab_indexing.py` | æ—  | ç´¢å¼•è½¬æ¢æµ‹è¯•ï¼ˆPythonç‰¹æœ‰ï¼‰ |
| `setup.py` | æ—  | åŒ…å®‰è£…é…ç½®ï¼ˆPythonç‰¹æœ‰ï¼‰ |

---

## æ•°æ®æµå›¾

```
è¾“å…¥æ–‡ä»¶
â”œâ”€â”€ parameters.dat â”€â”€â†’ parse_parameters_dat() â”€â”€â†’ GENEConfig
â”œâ”€â”€ equdata_BZ â”€â”€â”€â”€â”€â”€â†’ load_equdata_BZ() â”€â”€â”€â”€â”€â”€â†’ PA, GAC, GTC_c, ...
â”œâ”€â”€ equdata_be â”€â”€â”€â”€â”€â”€â†’ load_equdata_be() â”€â”€â”€â”€â”€â”€â†’ GBPR, GBPZ, ...
â”œâ”€â”€ LS_condition_*.txt â†’ load_beam_config() â”€â”€â”€â”€â†’ BeamConfig
â””â”€â”€ TORUSIons_act_*.dat â†’ generate_timedata() â”€â”€â†’ XXXXXX.dat
                                    â†“
                            fread_data_s() â”€â”€â”€â”€â”€â”€â†’ density_3d (401, 129, 11)
                                    â†“
                            forward_projection()
                                    â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                               â†“
        compute_beam_grid()              probe_local_trilinear()
                    â†“                               â†“
            beam_grid (xyz)              sampled_values
                    â†“                               â†“
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                            line_integral (sum)
                                    â†“
                            pci_signal (9, 25)
                                    â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                               â†“
        process_time_series()            FFT3DAnalyzer
                    â†“                               â†“
        IntegratedSignal.mat              FFTé¢‘è°±å›¾
```

---

## å…³é”®ä¿®æ­£è®°å½•

### å·²ä¿®æ­£çš„6ä¸ªå…³é”®é—®é¢˜

#### 1. æ•°æ®å¤„ç†æµç¨‹ (`fread_data_s`) - 3ä¸ªé—®é¢˜
- âœ… **å¾„å‘è¾¹ç•Œç¼ºå¤±**: æ·»åŠ `nx0+1`ç»´åº¦
- âœ… **Paddingç»´åº¦é”™è¯¯**: ä¿®æ­£ä¸º`nx0+1+inside+outside`
- âœ… **Poloidalé‡æ’ç´¢å¼•**: ä¿®æ­£MATLABåˆ°Pythonçš„ç´¢å¼•è½¬æ¢

#### 2. å…‰æŸå‡ ä½• (`beam_geometry.py`) - 2ä¸ªé—®é¢˜
- âœ… **å…‰æŸæ–¹å‘å‘é‡åå‘**: `p1 = B2_start - B2_end` (ä»ç»ˆç‚¹æŒ‡å‘èµ·ç‚¹)
- âœ… **phiè§’åº¦æœªè½¬æ¢**: `phi * 2 * np.pi`

#### 3. Bisecå‡½æ•° (`utils.py`) - 1ä¸ªé—®é¢˜
- âœ… **å‡åº/é™åºå¤„ç†**: æ·»åŠ æ•°ç»„æ–¹å‘æ£€æµ‹

**è¯¦ç»†ä¿®æ­£è®°å½•**: å‚è§ `COMPARISON_PROGRESS_REPORT.md` å’Œ `BEAM_GEOMETRY_FIX_REPORT.md`

---

## æ–‡ä»¶ä¾èµ–å…³ç³»

```
config.py
  â””â”€â”€ è¢«æ‰€æœ‰æ¨¡å—å¯¼å…¥

data_loader.py
  â”œâ”€â”€ ä¾èµ–: config.py
  â””â”€â”€ å¯¼å‡º: GENEConfig, BeamConfig, æ•°æ®åŠ è½½å‡½æ•°

beam_geometry.py
  â”œâ”€â”€ ä¾èµ–: config.py
  â””â”€â”€ å¯¼å‡º: å…‰æŸç½‘æ ¼è®¡ç®—å‡½æ•°

coordinates.py
  â”œâ”€â”€ ä¾èµ–: config.py
  â””â”€â”€ å¯¼å‡º: åæ ‡è½¬æ¢å‡½æ•°

interpolation.py
  â”œâ”€â”€ ä¾èµ–: config.py, utils.py
  â””â”€â”€ å¯¼å‡º: æ’å€¼å‡½æ•°

utils.py
  â””â”€â”€ å¯¼å‡º: å·¥å…·å‡½æ•°

forward_model.py
  â”œâ”€â”€ ä¾èµ–: config.py, beam_geometry.py, coordinates.py, interpolation.py
  â””â”€â”€ å¯¼å‡º: forward_projection()

batch_processor.py
  â”œâ”€â”€ ä¾èµ–: config.py, data_loader.py, forward_model.py
  â””â”€â”€ å¯¼å‡º: process_time_series()

fft_analysis.py
  â”œâ”€â”€ ä¾èµ–: config.py, path_config.py
  â””â”€â”€ å¯¼å‡º: FFT3DAnalyzer

visualization.py
  â”œâ”€â”€ ä¾èµ–: config.py
  â””â”€â”€ å¯¼å‡º: PCIVisualizer
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨æµç¨‹

```python
from pci_torch import (
    load_gene_config_from_parameters,
    load_beam_config,
    fread_data_s,
    forward_projection
)

# 1. åŠ è½½é…ç½®
config = load_gene_config_from_parameters(
    "parameters.dat",
    equilibrium_dir=".",
    device='cuda'
)

beam_config = load_beam_config("LS_condition_JT60SA.txt")

# 2. åŠ è½½å¯†åº¦åœº
density_3d = fread_data_s(config, "00000083.dat", device='cuda')

# 3. æ‰§è¡ŒPCIæ­£å‘æŠ•å½±
pci_signal = forward_projection(
    density_3d,
    config,
    beam_config,
    device='cuda'
)
```

### å®Œæ•´Pipeline

```python
from pci_torch.batch_processor import process_time_series

process_time_series(
    input_dir="./input",
    output_dir="./output",
    config=config,
    beam_config=beam_config,
    device='cuda'
)
```

---

## éªŒè¯çŠ¶æ€

### âœ… å·²éªŒè¯çš„æ¨¡å—

- [x] æ•°æ®å¤„ç†æµç¨‹ (`fread_data_s`)
- [x] å…‰æŸå‡ ä½•è®¡ç®— (`beam_geometry.py`)
- [x] Bisecå‡½æ•° (`bisec_batch`)
- [x] ProbeEQæ’å€¼ (`probe_local_trilinear`)

### ğŸ“Š æµ‹è¯•ç»“æœ

**å•æ—¶é—´ç‚¹æµ‹è¯• (t=0.83)**:
- ä¿¡å·èŒƒå›´: [1010.53, 26931.46] âœ…
- ä¿¡å·å‡å€¼: 7403.19 âœ…
- ä¿¡å·æ ‡å‡†å·®: 8323.21 âœ…

**è¯¦ç»†éªŒè¯æŠ¥å‘Š**: å‚è§ `PROBEQ_VERIFICATION_REPORT.md`

---

## ç›¸å…³æ–‡æ¡£

- **ä½¿ç”¨æŒ‡å—**: `COMPLETE_GUIDE.md`
- **è·¯å¾„é…ç½®**: `PATHCONFIG_GUIDE.md`
- **å¯¹æ¯”æ£€æŸ¥æ¸…å•**: `MATLAB_PYTHON_COMPARISON_CHECKLIST.md`
- **ä¿®æ­£æŠ¥å‘Š**: `COMPARISON_PROGRESS_REPORT.md`
- **å…‰æŸå‡ ä½•ä¿®æ­£**: `BEAM_GEOMETRY_FIX_REPORT.md`
- **ProbeEQéªŒè¯**: `PROBEQ_VERIFICATION_REPORT.md`

---

**æœ€åæ›´æ–°**: 2025å¹´11æœˆ6æ—¥  
**ç»´æŠ¤è€…**: PyPCIå¼€å‘å›¢é˜Ÿ

